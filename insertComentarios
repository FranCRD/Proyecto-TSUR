<!-- ===== SECCIÓN COMENTARIOS EN EL INICIO ===== -->
<?php
session_start();
include "conexion.php";
?>

<section id="comentarios" class="comentarios">
    <h2>Comentarios</h2>

    <div class="comentarios-contenedor">

        <!-- FORMULARIO -->
        <?php if (isset($_SESSION['nombre_usuario'])): ?>
            <form class="form-comentarios" method="post" action="">

                <div class="campo">
                    <label for="nombre_usuario">Nombre de usuario</label>
                    <input type="text" id="nombre_usuario" name="nombre_usuario"
                           value="<?php echo htmlspecialchars($_SESSION['nombre_usuario']); ?>"
                           readonly>
                </div>

                <div class="campo">
                    <label for="valoracion">Calificación</label>
                    <select id="valoracion" name="valoracion" required>
                        <option value="">Seleccione una calificación</option>
                        <option value="1">1 / 5</option>
                        <option value="2">2 / 5</option>
                        <option value="3">3 / 5</option>
                        <option value="4">4 / 5</option>
                        <option value="5">5 / 5</option>
                    </select>
                </div>

                <div class="campo">
                    <label for="TituloComentario">Título</label>
                    <input type="text" id="TituloComentario" name="TituloComentario"
                           placeholder="Título del comentario" required>
                </div>

                <div class="campo">
                    <label for="Comentario">Comentario</label>
                    <textarea id="Comentario" name="Comentario" rows="4"
                              placeholder="Escriba su comentario" required></textarea>
                </div>

                <!-- AHORA SÍ TIENE NAME="enviar" -->
                <button type="submit" name="enviar">Publicar</button>
            </form>
        <?php else: ?>
            <p>Debe iniciar sesión para poder publicar un comentario.</p>
        <?php endif; ?>


        <!-- LISTA DE COMENTARIOS -->
        <div class="lista-comentarios">
            <?php
            $result = $conexion->query("SELECT * FROM comentario ORDER BY idComentario DESC");

            if ($result->num_rows > 0) {
                while($row = $result->fetch_assoc()) {
                    echo '<div style="border:1px solid #ccc; padding:10px; margin:10px 0;">';
                    echo '<b>Usuario:</b> '.$row["nombre_usuario"].'<br>';
                    echo '<b>Calificación:</b> '.$row["valoracion"].'/5<br>';
                    echo '<h4>'.htmlspecialchars($row["TituloComentario"]).'</h4>';
                    echo '<p>'.nl2br(htmlspecialchars($row["Comentario"])).'</p>';        
                    
                    echo '<small>'.$row["Fecha"].'</small>';
                    echo '</div>';
                }
            } else {
                echo "<p>No hay comentarios aún.</p>";
            }
            ?>
        </div>
    </div>
</section>

<?php
// ===== INSERT DE COMENTARIOS CORREGIDO =====
if (isset($_POST['enviar'])) {

    $usuario    = $_SESSION['nombre_usuario'];
    $titulo     = $_POST['TituloComentario'];
    $comentario = $_POST['Comentario'];
    $valoracion = $_POST['valoracion'];
    $fecha      = date("Y-m-d H:i:s");

    $stmt = $conexion->prepare("
        INSERT INTO comentario (TituloComentario, Comentario, nombre_usuario, valoracion, Fecha)
        VALUES (?, ?, ?, ?, ?)
    ");

    $stmt->bind_param("sssds", $titulo, $comentario, $usuario, $valoracion, $fecha);

    if ($stmt->execute()) {
        header("Location: comentarios.php");
        exit();
    } else {
        echo "Error: " . $conexion->error;
    }
}
?>
